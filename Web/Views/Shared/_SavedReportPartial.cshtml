@model Web.ViewModels.SavedReportViewModel

@{
    Layout = null;
}

@if(Model.IsPublished) {
    <div class="">
        This report is published and you cannot change the parameters.
    </div>
} else {
    <form id="savedReportPartialForm" asp-route="CreateSavedReport">
        <fieldset>
            <input type="hidden" asp-for="Name" />
            <input type="hidden" asp-for="CompanyId" />
            <input type="hidden" asp-for="Date" value="@Model.Date.ToString("yyyy-MM-dd")" />
            <input type="hidden" asp-for="NumberOfPeriods" />

            <div class="form-group">
                <label asp-for="Name"></label>
                <input value="@Model.Name" class="form-control" disabled />
            </div>
            <div class="form-row mb-3">
                <div class="col">
                    <label asp-for="Date"></label>
                    <input value="@Model.Date" class="form-control" disabled />
                </div>
                <div class="col">
                    <label asp-for="NumberOfPeriods"></label>
                    <input value="@Model.NumberOfPeriods" class="form-control" disabled />
                </div>
            </div>
            <div class="form-group mb-3">
                <label>Save report as:</label>
                @foreach(var settings in ViewBag.Settings) {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="@settings.Id" id="settings_@settings.Id" name="ExportSettings[]" checked>
                        <label class="form-check-label" for="settings_@settings.Id">
                            @settings.Name
                        </label>
                    </div>
                }
            </div>
        </fieldset>
    </form>
}

<script type="text/javascript">
    $(document).ready(e => {
        var $savedReportPartialForm = $('#savedReportPartialForm').on('submit', e => {
            e.preventDefault();

            var formData = $(e.target).serializeJSON();
            var opt = {
                url: '/api/report/savedReport',
                data: { 'companyId': formData.CompanyId, 'date': formData.Date }
            };

            $.when($.ajax(opt)).then((report) => {
                if (report != null) {
                    if (!confirm("This report exists in the database. Are you sure to overwrite it?")) {
                        return;
                    }
                } 

                $(e.target).ajaxSubmit({}, (target, data, status) => {
                    status === 'success' ? window.modal.modal('hide') : alert(status);
                });
            });

        });
    });
</script>
