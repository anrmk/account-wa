@model Web.ViewModels.BulkInvoiceViewModel
@{
    ViewData["Title"] = "Create Bulk Invoicing";
    ViewData["SubTitle"] = "Bulk Invoicing is ideal for when you have a lot of clients to bill for a lot of work. Use the Bulk Invoice wizard to quickly create and send invoices to all of your clients quickly!";
}

<form class="need-validation" id="bulkForm" asp-action="BulkCreate" asp-controller="Invoice">
    <fieldset>
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 col">
                        <div class="form-group">
                            <label asp-for="CompanyId"></label>
                            <select id="companies" asp-for="CompanyId" asp-items="@ViewBag.Companies" class="form-control selectpicker"
                                    required
                                    data-live-search="true">
                                <option>Chose a company</option>
                            </select>
                            <span asp-validation-for="CompanyId" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label>Summary Range</label>
                            <select id="summaryRange" asp-items="@ViewBag.SummaryRange" class="form-control selectpicker"
                                    required
                                    data-live-search="true">
                                <option>Chose a summary range</option>
                            </select>
                            <span class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="DateFrom"></label>
                            <input asp-for="DateFrom" type="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label asp-for="DateTo"></label>
                            <input asp-for="DateTo" type="date" class="form-control" required>
                        </div>
                    </div>

                    <div class="col-lg-8 col">
                        <div class="form-group">
                            <label>Customers</label>
                            <div id="toolbar" role="toolbar">
                                <a id="checkAll" href="#" class="btn btn-secondary">checkAll</a>
                                <a id="unckeckAll" href="#" class="btn btn-secondary">uncheckAll</a>
                            </div>
                            <table id="datatable" class="table table-striped table-sm" data-toggle="table"
                                   *data-search="true"
                                   data-toolbar="#toolbar"
                                   data-thead-classes="thead-dark"
                                   data-id-field="id"
                                   data-select-item-name="Customers[]"
                                   data-click-to-select="true"
                                   @*data-side-pagination="server"*@
                                   data-pagination="true"
                                   data-show-extended-pagination="true"
                                   @*data-total-field="totalItems"
                                   data-data-field="items"*@
                                   data-height="460">

                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true"></th>
                                        <th data-field="accountNumber" scope="col" class="text-nowrap">No</th>
                                        <th data-field="name" scope="col">Name</th>
                                        <th data-field="terms" scope="col">Terms</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer" role="toolbar" aria-label="Toolbar with button groups">
                <button type="submit" class="btn btn-primary">Generate</button>
                <a asp-action="index" class="btn btn-link">Cancel</a>
            </div>
        </div>
    </fieldset>
</form>

<div id="content">

</div>


@section Scripts {
    <script type="text/javascript">
        var $form = $('#bulkForm');
        var $table = $('#datatable');
        var $checkall = $('#checkAll');
        var $unckeckAll = $('#unckeckAll');

        $('#companies').on('change', (e) => {
            var id = $(e.currentTarget).val();
            $.when($.ajax(`/api/company/${id}`), $.ajax(`/api/customer/company/${id}`)).then((company, customers) => {
                $table.bootstrapTable('load', customers[0])
            });
        });

        $checkall.click(function () {
            $table.bootstrapTable('checkAll');
        });

        $unckeckAll.click(function () {
            $table.bootstrapTable('uncheckAll');
        });

        $form.submit(e => {
            var fieldset = $form.find('fieldset');

            var postData = JSON.stringify($form.serializeJSON({ parseNumbers: true }));
            var formURL = $form.attr("action");
            //let validator = $($form).validate();

            var options = {
                'url': '/api/invoice/bulk',
                'type': 'POST',
                'data': postData,
                'processData': false,
                'contentType': 'application/json; charset=utf-8',
                success: function (data, textStatus, jqXHR) {
                    $('#content').append(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                }
            };
            e.preventDefault();
        });
    </script>
}